#!/usr/bin/env node

function getArguments(args){
	var unprocessed = args,
		processed = {}, 
		key = "", 
		value = "";

	for(var i = 0; i < unprocessed.length; i++){
		var arg = unprocessed[i];
		if(arg.substr(0,2) == "--"){
			if(key){
				processed[key] = value;
				key = "";
				value = "";
			}
			key = arg.substr(2);
		} else {
			if(key) value += (value?" ":"") + arg;
		}
	};

	if(key){
		processed[key] = value;
		key = "";
		value = "";
	};

	return processed;
};

var arguments = getArguments(process.argv);
var options = {
	format: arguments.format || "simple",
	output: arguments.output || null,
	debug: "debug" in arguments,
	runner: arguments.runner,
	help: "help" in arguments
};

function _getAbsolutePath(file){
	var path;
	if (file.substring(0,1) == "/"){
		path = file;
	} else {
		path = process.cwd() + '/' + file;
	}
	return require('path').normalize(path);
};

function _getUsage(){
	return "Usage: node run.js --runner <path> [--format simple|nice|json|html|junit] [--output <path>] [--help]";
};

function _formatNice(obj){
	if(obj.failed == 0){
		return "Passed";
	} else {
		var message = "Failed: \n";
		for( var k in obj.failureDetails ){
			var details = obj.failureDetails[k];
			message += " - In " + details.suite + ", " + details.spec + ": " + details.message + "\n";
		}
		return message;
	}
};

function _format(report){
	var result = '';

	switch(options.format){
		case 'simple':
			result = report.simple.status;
			break;
		case 'json':
			result = JSON.stringify(report.simple);
			break;
		case 'nice':
			result = _formatNice(report.simple);
			break;
		case 'html':
			result = report.html;
			break;
		case 'junit':
			result = report.junit;
			break;
		default:
			console.error("Unknown format:" + options.format);
			process.exit(0);
			break;
	};

	return result;
};

function _output(text){
	if(options.output){
		var file = _getAbsolutePath(options.output);
		require('fs').writeFile(file,text,function(err){
			if(err) console.log("Something went wrong writing the report to disk: ",err);
		});
	} else {
		console.log(text);
	}
};

function _processReport(report){
	var text = _format(report);
	_output(text);
};

function validate(options){
	if (options.help){
		console.log(_getUsage());
		process.exit(0);
	}
	if (! options.runner) {
		console.error("You need to specify a html --runner file.\n");
		console.log(_getUsage());
		process.exit(0);
	}
};

validate(options);

require('../lib/jasmine-dom').run({
	runners: [
		_getAbsolutePath(options.runner)
	],
	debug: options.debug,
	onDone: function(report){
		_processReport(report);
	}
});